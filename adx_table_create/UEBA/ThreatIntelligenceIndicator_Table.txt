.create table ThreatIntelligenceIndicatorRaw (Records:dynamic)

.create table ThreatIntelligenceIndicatorRaw ingestion json mapping 'ThreatIntelligenceIndicatorRawMapping' '[{"column":"Records","Properties":{"path":"$.records"}}]'

.alter-merge table ThreatIntelligenceIndicatorRaw policy retention softdelete = 0d

.create table ThreatIntelligenceIndicator (TenantId:string,TimeGenerated:datetime,SourceSystem:string,Action:string,ActivityGroupNames:string,AdditionalInformation:string,ApplicationId:string,AzureTenantId:string,ConfidenceScore:string,Description:string,DiamondModel:string,ExternalIndicatorId:string,ExpirationDateTime:datetime,IndicatorId:string,ThreatType:string,Active:string,KillChainActions:string,KillChainC2:string,KillChainDelivery:string,KillChainExploitation:string,KillChainReconnaissance:string,KillChainWeaponization:string,KnownFalsePositives:string,MalwareNames:string,PassiveOnly:string,ThreatSeverity:string,Tags:string,TrafficLightProtocolLevel:string,EmailEncoding:string,EmailLanguage:string,EmailRecipient:string,EmailSenderAddress:string,EmailSenderName:string,EmailSourceDomain:string,EmailSourceIpAddress:string,EmailSubject:string,EmailXMailer:string,FileCompileDateTime:datetime,FileCreatedDateTime:datetime,FileHashType:string,FileHashValue:string,FileMutexName:string,FileName:string,FilePacker:string,FilePath:string,FileSize:string,FileType:string,DomainName:string,NetworkIP:string,NetworkPort:string,NetworkDestinationAsn:string,NetworkDestinationCidrBlock:string,NetworkDestinationIP:string,NetworkCidrBlock:string,NetworkDestinationPort:string,NetworkProtocol:string,NetworkSourceAsn:string,NetworkSourceCidrBlock:string,NetworkSourceIP:string,NetworkSourcePort:string,Url:string,UserAgent:string,IndicatorProvider:string,Type:string)

.create-or-alter function ThreatIntelligenceIndicatorExpand() {
    ThreatIntelligenceIndicatorRaw
| mv-expand events = Records | where events.Type == 'ThreatIntelligenceIndicator' and isnotempty(events.TimeGenerated)
| project TenantId = tostring(events.TenantId),TimeGenerated = todatetime(events.TimeGenerated),SourceSystem = tostring(events.SourceSystem),Action = tostring(events.Action),ActivityGroupNames = tostring(events.ActivityGroupNames),AdditionalInformation = tostring(events.AdditionalInformation),ApplicationId = tostring(events.ApplicationId),AzureTenantId = tostring(events.AzureTenantId),ConfidenceScore = tostring(events.ConfidenceScore),Description = tostring(events.Description),DiamondModel = tostring(events.DiamondModel),ExternalIndicatorId = tostring(events.ExternalIndicatorId),ExpirationDateTime = todatetime(events.ExpirationDateTime),IndicatorId = tostring(events.IndicatorId),ThreatType = tostring(events.ThreatType),Active = tostring(events.Active),KillChainActions = tostring(events.KillChainActions),KillChainC2 = tostring(events.KillChainC2),KillChainDelivery = tostring(events.KillChainDelivery),KillChainExploitation = tostring(events.KillChainExploitation),KillChainReconnaissance = tostring(events.KillChainReconnaissance),KillChainWeaponization = tostring(events.KillChainWeaponization),KnownFalsePositives = tostring(events.KnownFalsePositives),MalwareNames = tostring(events.MalwareNames),PassiveOnly = tostring(events.PassiveOnly),ThreatSeverity = tostring(events.ThreatSeverity),Tags = tostring(events.Tags),TrafficLightProtocolLevel = tostring(events.TrafficLightProtocolLevel),EmailEncoding = tostring(events.EmailEncoding),EmailLanguage = tostring(events.EmailLanguage),EmailRecipient = tostring(events.EmailRecipient),EmailSenderAddress = tostring(events.EmailSenderAddress),EmailSenderName = tostring(events.EmailSenderName),EmailSourceDomain = tostring(events.EmailSourceDomain),EmailSourceIpAddress = tostring(events.EmailSourceIpAddress),EmailSubject = tostring(events.EmailSubject),EmailXMailer = tostring(events.EmailXMailer),FileCompileDateTime = todatetime(events.FileCompileDateTime),FileCreatedDateTime = todatetime(events.FileCreatedDateTime),FileHashType = tostring(events.FileHashType),FileHashValue = tostring(events.FileHashValue),FileMutexName = tostring(events.FileMutexName),FileName = tostring(events.FileName),FilePacker = tostring(events.FilePacker),FilePath = tostring(events.FilePath),FileSize = tostring(events.FileSize),FileType = tostring(events.FileType),DomainName = tostring(events.DomainName),NetworkIP = tostring(events.NetworkIP),NetworkPort = tostring(events.NetworkPort),NetworkDestinationAsn = tostring(events.NetworkDestinationAsn),NetworkDestinationCidrBlock = tostring(events.NetworkDestinationCidrBlock),NetworkDestinationIP = tostring(events.NetworkDestinationIP),NetworkCidrBlock = tostring(events.NetworkCidrBlock),NetworkDestinationPort = tostring(events.NetworkDestinationPort),NetworkProtocol = tostring(events.NetworkProtocol),NetworkSourceAsn = tostring(events.NetworkSourceAsn),NetworkSourceCidrBlock = tostring(events.NetworkSourceCidrBlock),NetworkSourceIP = tostring(events.NetworkSourceIP),NetworkSourcePort = tostring(events.NetworkSourcePort),Url = tostring(events.Url),UserAgent = tostring(events.UserAgent),IndicatorProvider = tostring(events.IndicatorProvider),Type = tostring(events.Type)
}

.alter table ThreatIntelligenceIndicator policy update @'[{"Source": "ThreatIntelligenceIndicatorRaw", "Query": "ThreatIntelligenceIndicatorExpand()", "IsEnabled": true, "IsTransactional": true}]'
