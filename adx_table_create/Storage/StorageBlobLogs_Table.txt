.create table StorageBlobLogsRaw (Records:dynamic)

.create table StorageBlobLogsRaw ingestion json mapping 'StorageBlobLogsRawMapping' '[{"column":"Records","Properties":{"path":"$.records"}}]'

.alter-merge table StorageBlobLogsRaw policy retention softdelete = 0d

.create table StorageBlobLogs (TenantId:string,TimeGenerated:datetime,AccountName:string,Location:string,Protocol:string,OperationName:string,AuthenticationType:string,StatusCode:string,StatusText:string,DurationMs:string,ServerLatencyMs:string,Uri:string,CallerIpAddress:string,CorrelationId:string,SchemaVersion:string,OperationVersion:string,AuthenticationHash:string,RequesterObjectId:string,RequesterTenantId:string,RequesterAppId:string,RequesterAudience:string,RequesterTokenIssuer:string,RequesterUpn:string,AuthorizationDetails:string,UserAgentHeader:string,ReferrerHeader:string,ClientRequestId:string,Etag:string,ServiceType:string,OperationCount:string,ObjectKey:string,RequestHeaderSize:string,RequestBodySize:string,ResponseHeaderSize:string,ResponseBodySize:string,RequestMd5:string,ResponseMd5:string,LastModifiedTime:datetime,ConditionsUsed:string,ContentLengthHeader:string,Category:string,TlsVersion:string,SasExpiryStatus:string,MetricResponseType:string,SourceUri:string,DestinationUri:string,AccessTier:string,SourceAccessTier:string,RehydratePriority:string,SourceSystem:string,Type:string,_ResourceId:string)

.create-or-alter function StorageBlobLogsExpand() {
    StorageBlobLogsRaw
| mv-expand events = Records | where events.Type == 'StorageBlobLogs' and isnotempty(events.TimeGenerated)
| project TenantId = tostring(events.TenantId),TimeGenerated = todatetime(events.TimeGenerated),AccountName = tostring(events.AccountName),Location = tostring(events.Location),Protocol = tostring(events.Protocol),OperationName = tostring(events.OperationName),AuthenticationType = tostring(events.AuthenticationType),StatusCode = tostring(events.StatusCode),StatusText = tostring(events.StatusText),DurationMs = tostring(events.DurationMs),ServerLatencyMs = tostring(events.ServerLatencyMs),Uri = tostring(events.Uri),CallerIpAddress = tostring(events.CallerIpAddress),CorrelationId = tostring(events.CorrelationId),SchemaVersion = tostring(events.SchemaVersion),OperationVersion = tostring(events.OperationVersion),AuthenticationHash = tostring(events.AuthenticationHash),RequesterObjectId = tostring(events.RequesterObjectId),RequesterTenantId = tostring(events.RequesterTenantId),RequesterAppId = tostring(events.RequesterAppId),RequesterAudience = tostring(events.RequesterAudience),RequesterTokenIssuer = tostring(events.RequesterTokenIssuer),RequesterUpn = tostring(events.RequesterUpn),AuthorizationDetails = tostring(events.AuthorizationDetails),UserAgentHeader = tostring(events.UserAgentHeader),ReferrerHeader = tostring(events.ReferrerHeader),ClientRequestId = tostring(events.ClientRequestId),Etag = tostring(events.Etag),ServiceType = tostring(events.ServiceType),OperationCount = tostring(events.OperationCount),ObjectKey = tostring(events.ObjectKey),RequestHeaderSize = tostring(events.RequestHeaderSize),RequestBodySize = tostring(events.RequestBodySize),ResponseHeaderSize = tostring(events.ResponseHeaderSize),ResponseBodySize = tostring(events.ResponseBodySize),RequestMd5 = tostring(events.RequestMd5),ResponseMd5 = tostring(events.ResponseMd5),LastModifiedTime = todatetime(events.LastModifiedTime),ConditionsUsed = tostring(events.ConditionsUsed),ContentLengthHeader = tostring(events.ContentLengthHeader),Category = tostring(events.Category),TlsVersion = tostring(events.TlsVersion),SasExpiryStatus = tostring(events.SasExpiryStatus),MetricResponseType = tostring(events.MetricResponseType),SourceUri = tostring(events.SourceUri),DestinationUri = tostring(events.DestinationUri),AccessTier = tostring(events.AccessTier),SourceAccessTier = tostring(events.SourceAccessTier),RehydratePriority = tostring(events.RehydratePriority),SourceSystem = tostring(events.SourceSystem),Type = tostring(events.Type),_ResourceId = tostring(events._ResourceId)
}

.alter table StorageBlobLogs policy update @'[{"Source": "StorageBlobLogsRaw", "Query": "StorageBlobLogsExpand()", "IsEnabled": true, "IsTransactional": true}]'
