.create table StorageFileLogsRaw (Records:dynamic)

.create table StorageFileLogsRaw ingestion json mapping 'StorageFileLogsRawMapping' '[{"column":"Records","Properties":{"path":"$.records"}}]'

.alter-merge table StorageFileLogsRaw policy retention softdelete = 0d

.create table StorageFileLogs (TenantId:string,TimeGenerated:datetime,AccountName:string,Location:string,Protocol:string,OperationName:string,AuthenticationType:string,StatusCode:string,StatusText:string,DurationMs:real,ServerLatencyMs:real,Uri:string,CallerIpAddress:string,CorrelationId:string,SchemaVersion:string,OperationVersion:string,AuthenticationHash:string,RequesterObjectId:string,RequesterTenantId:string,RequesterAppId:string,RequesterAudience:string,RequesterTokenIssuer:string,RequesterUpn:string,RequesterUserName:string,AuthorizationDetails:string,SmbPrimarySID:string,UserAgentHeader:string,ReferrerHeader:string,ClientRequestId:string,Etag:string,ServiceType:string,OperationCount:int,ObjectKey:string,RequestHeaderSize:string,RequestBodySize:string,ResponseHeaderSize:string,ResponseBodySize:string,RequestMd5:string,ResponseMd5:string,LastModifiedTime:datetime,ConditionsUsed:string,ContentLengthHeader:string,Category:string,TlsVersion:string,SmbTreeConnectID:string,SmbPersistentHandleID:string,SmbVolatileHandleID:string,SmbMessageID:string,SmbCreditsConsumed:int,SmbCommandDetail:string,SmbFileId:string,SmbSessionID:string,SmbCommandMajor:int,SmbCommandMinor:string,SasExpiryStatus:string,MetricResponseType:string,SmbStatusCode:string,SourceSystem:string,Type:string,_ResourceId:string)

.create-or-alter function StorageFileLogsExpand() {
    StorageFileLogsRaw
| mv-expand events = Records | where events.Type == 'StorageFileLogs' and isnotempty(events.TimeGenerated)
| project TenantId = tostring(events.TenantId),TimeGenerated = todatetime(events.TimeGenerated),AccountName = tostring(events.AccountName),Location = tostring(events.Location),Protocol = tostring(events.Protocol),OperationName = tostring(events.OperationName),AuthenticationType = tostring(events.AuthenticationType),StatusCode = tostring(events.StatusCode),StatusText = tostring(events.StatusText),DurationMs = toreal(events.DurationMs),ServerLatencyMs = toreal(events.ServerLatencyMs),Uri = tostring(events.Uri),CallerIpAddress = tostring(events.CallerIpAddress),CorrelationId = tostring(events.CorrelationId),SchemaVersion = tostring(events.SchemaVersion),OperationVersion = tostring(events.OperationVersion),AuthenticationHash = tostring(events.AuthenticationHash),RequesterObjectId = tostring(events.RequesterObjectId),RequesterTenantId = tostring(events.RequesterTenantId),RequesterAppId = tostring(events.RequesterAppId),RequesterAudience = tostring(events.RequesterAudience),RequesterTokenIssuer = tostring(events.RequesterTokenIssuer),RequesterUpn = tostring(events.RequesterUpn),RequesterUserName = tostring(events.RequesterUserName),AuthorizationDetails = tostring(events.AuthorizationDetails),SmbPrimarySID = tostring(events.SmbPrimarySID),UserAgentHeader = tostring(events.UserAgentHeader),ReferrerHeader = tostring(events.ReferrerHeader),ClientRequestId = tostring(events.ClientRequestId),Etag = tostring(events.Etag),ServiceType = tostring(events.ServiceType),OperationCount = toint(events.OperationCount),ObjectKey = tostring(events.ObjectKey),RequestHeaderSize = tostring(events.RequestHeaderSize),RequestBodySize = tostring(events.RequestBodySize),ResponseHeaderSize = tostring(events.ResponseHeaderSize),ResponseBodySize = tostring(events.ResponseBodySize),RequestMd5 = tostring(events.RequestMd5),ResponseMd5 = tostring(events.ResponseMd5),LastModifiedTime = todatetime(events.LastModifiedTime),ConditionsUsed = tostring(events.ConditionsUsed),ContentLengthHeader = tostring(events.ContentLengthHeader),Category = tostring(events.Category),TlsVersion = tostring(events.TlsVersion),SmbTreeConnectID = tostring(events.SmbTreeConnectID),SmbPersistentHandleID = tostring(events.SmbPersistentHandleID),SmbVolatileHandleID = tostring(events.SmbVolatileHandleID),SmbMessageID = tostring(events.SmbMessageID),SmbCreditsConsumed = toint(events.SmbCreditsConsumed),SmbCommandDetail = tostring(events.SmbCommandDetail),SmbFileId = tostring(events.SmbFileId),SmbSessionID = tostring(events.SmbSessionID),SmbCommandMajor = toint(events.SmbCommandMajor),SmbCommandMinor = tostring(events.SmbCommandMinor),SasExpiryStatus = tostring(events.SasExpiryStatus),MetricResponseType = tostring(events.MetricResponseType),SmbStatusCode = tostring(events.SmbStatusCode),SourceSystem = tostring(events.SourceSystem),Type = tostring(events.Type),_ResourceId = tostring(events._ResourceId)
}

.alter table StorageFileLogs policy update @'[{"Source": "StorageFileLogsRaw", "Query": "StorageFileLogsExpand()", "IsEnabled": true, "IsTransactional": true}]'
