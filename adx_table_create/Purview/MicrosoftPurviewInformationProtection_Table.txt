.create table MicrosoftPurviewInformationProtectionRaw (Records:dynamic)

.create table MicrosoftPurviewInformationProtectionRaw ingestion json mapping 'MicrosoftPurviewInformationProtectionRawMapping' '[{"column":"Records","Properties":{"path":"$.records"}}]'

.alter-merge table MicrosoftPurviewInformationProtectionRaw policy retention softdelete = 0d

.create table MicrosoftPurviewInformationProtection (TenantId:string,Id:string,RecordType:string,RecordTypeName:string,TimeGenerated:datetime,Operation:string,OrganizationId:string,UserType:string,UserKey:string,Workload:string,ResultStatus:string,ObjectId:string,UserId:string,ClientIP:string,Scope:string,AppAccessContext:string,Application:string,Platform:string,DeviceName:string,EmailInfo:string,CurrentProtectionTypeName:string,PreviousProtectionTypeName:string,ContentType:string,TargetLocation:string,IrmContentId:string,SensitivityLabelId:string,SensitivityLabelOwnerEmail:string,OldSensitivityLabelId:string,OldSensitivityLabelOwnerEmail:string,SensitivityLabelPolicyId:string,LabelEventType:string,ActionSource:string,ActionSourceDetail:string,JustificationText:string,SensitiveInfoTypeData:string,ProtectionEventData:string,Common:string,DataState:string,ProtectionEventTypeName:string,Sender:string,Receivers:string,ItemName:string,LabelName:string,LabelAction:string,LabelAppliedDateTime:datetime,ApplicationMode:string,ExchangeMetaData:string,ConditionMatch:string,RuleActions:string,WorkLoadItemId:string,OverriddenActions:string,SensitiveInfoDetectionIsIncluded:string,IsViewableByExternalUsers:string,OverRideType:string,ItemCreationTime:datetime,ItemLastModifiedTime:datetime,ItemSize:string,OverRideReason:string,CorrelationId:string,ScopedLocationId:string,MachineName:string,PolicyId:string,PolicyName:string,PolicyVersion:string,ExecutionRuleId:string,ExecutionRuleName:string,ExecutionRuleVersion:string,RuleMode:string,Severity:string,LabelVersion:string,MgtRuleId:string,SharePointMetaData:string,CurrentProtectionType:string,PreviousProtectionType:string,SourceSystem:string,Type:string)

.create-or-alter function MicrosoftPurviewInformationProtectionExpand() {
    MicrosoftPurviewInformationProtectionRaw
| mv-expand events = Records | where events.Type == 'MicrosoftPurviewInformationProtection' and isnotempty(events.TimeGenerated)
| project TenantId = tostring(events.TenantId),Id = tostring(events.Id),RecordType = tostring(events.RecordType),RecordTypeName = tostring(events.RecordTypeName),TimeGenerated = todatetime(events.TimeGenerated),Operation = tostring(events.Operation),OrganizationId = tostring(events.OrganizationId),UserType = tostring(events.UserType),UserKey = tostring(events.UserKey),Workload = tostring(events.Workload),ResultStatus = tostring(events.ResultStatus),ObjectId = tostring(events.ObjectId),UserId = tostring(events.UserId),ClientIP = tostring(events.ClientIP),Scope = tostring(events.Scope),AppAccessContext = tostring(events.AppAccessContext),Application = tostring(events.Application),Platform = tostring(events.Platform),DeviceName = tostring(events.DeviceName),EmailInfo = tostring(events.EmailInfo),CurrentProtectionTypeName = tostring(events.CurrentProtectionTypeName),PreviousProtectionTypeName = tostring(events.PreviousProtectionTypeName),ContentType = tostring(events.ContentType),TargetLocation = tostring(events.TargetLocation),IrmContentId = tostring(events.IrmContentId),SensitivityLabelId = tostring(events.SensitivityLabelId),SensitivityLabelOwnerEmail = tostring(events.SensitivityLabelOwnerEmail),OldSensitivityLabelId = tostring(events.OldSensitivityLabelId),OldSensitivityLabelOwnerEmail = tostring(events.OldSensitivityLabelOwnerEmail),SensitivityLabelPolicyId = tostring(events.SensitivityLabelPolicyId),LabelEventType = tostring(events.LabelEventType),ActionSource = tostring(events.ActionSource),ActionSourceDetail = tostring(events.ActionSourceDetail),JustificationText = tostring(events.JustificationText),SensitiveInfoTypeData = tostring(events.SensitiveInfoTypeData),ProtectionEventData = tostring(events.ProtectionEventData),Common = tostring(events.Common),DataState = tostring(events.DataState),ProtectionEventTypeName = tostring(events.ProtectionEventTypeName),Sender = tostring(events.Sender),Receivers = tostring(events.Receivers),ItemName = tostring(events.ItemName),LabelName = tostring(events.LabelName),LabelAction = tostring(events.LabelAction),LabelAppliedDateTime = todatetime(events.LabelAppliedDateTime),ApplicationMode = tostring(events.ApplicationMode),ExchangeMetaData = tostring(events.ExchangeMetaData),ConditionMatch = tostring(events.ConditionMatch),RuleActions = tostring(events.RuleActions),WorkLoadItemId = tostring(events.WorkLoadItemId),OverriddenActions = tostring(events.OverriddenActions),SensitiveInfoDetectionIsIncluded = tostring(events.SensitiveInfoDetectionIsIncluded),IsViewableByExternalUsers = tostring(events.IsViewableByExternalUsers),OverRideType = tostring(events.OverRideType),ItemCreationTime = todatetime(events.ItemCreationTime),ItemLastModifiedTime = todatetime(events.ItemLastModifiedTime),ItemSize = tostring(events.ItemSize),OverRideReason = tostring(events.OverRideReason),CorrelationId = tostring(events.CorrelationId),ScopedLocationId = tostring(events.ScopedLocationId),MachineName = tostring(events.MachineName),PolicyId = tostring(events.PolicyId),PolicyName = tostring(events.PolicyName),PolicyVersion = tostring(events.PolicyVersion),ExecutionRuleId = tostring(events.ExecutionRuleId),ExecutionRuleName = tostring(events.ExecutionRuleName),ExecutionRuleVersion = tostring(events.ExecutionRuleVersion),RuleMode = tostring(events.RuleMode),Severity = tostring(events.Severity),LabelVersion = tostring(events.LabelVersion),MgtRuleId = tostring(events.MgtRuleId),SharePointMetaData = tostring(events.SharePointMetaData),CurrentProtectionType = tostring(events.CurrentProtectionType),PreviousProtectionType = tostring(events.PreviousProtectionType),SourceSystem = tostring(events.SourceSystem),Type = tostring(events.Type)
}

.alter table MicrosoftPurviewInformationProtection policy update @'[{"Source": "MicrosoftPurviewInformationProtectionRaw", "Query": "MicrosoftPurviewInformationProtectionExpand()", "IsEnabled": true, "IsTransactional": true}]'
