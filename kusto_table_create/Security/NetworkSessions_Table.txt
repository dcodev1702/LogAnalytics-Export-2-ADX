.create table NetworkSessionsRaw (Records:dynamic)

.create table NetworkSessionsRaw ingestion json mapping 'NetworkSessionsRawMapping' '[{"column":"Records","Properties":{"path":"$.records"}}]'

.alter-merge table NetworkSessionsRaw policy retention softdelete = 0d

.create table NetworkSessions (TenantId:string,EventType:string,EventSubType:string,EventCount:string,EventEndTime:datetime,EventMessage:string,DvcIpAddr:string,DvcMacAddr:string,DvcHostname:string,EventProduct:string,EventProductVersion:string,EventResourceId:string,EventReportUrl:string,EventVendor:string,EventResult:string,EventResultDetails:string,EventSchemaVersion:string,EventSeverity:string,EventOriginalUid:string,EventStartTime:datetime,TimeGenerated:datetime,EventTimeIngested:datetime,EventUid:string,NetworkApplicationProtocol:string,DstBytes:string,SrcBytes:string,NetworkBytes:string,NetworkDirection:string,DstGeoCity:string,DstGeoCountry:string,DstDvcHostname:string,DstDvcFqdn:string,DstDomainHostname:string,DstInterfaceName:string,DstInterfaceGuid:string,DstIpAddr:string,DstDvcIpAddr:string,DstGeoLatitude:string,DstMacAddr:string,DstDvcMacAddr:string,DstDvcDomain:string,DstPortNumber:string,DstGeoRegion:string,DstResourceId:string,DstNatIpAddr:string,DstNatPortNumber:string,DstUserSid:string,DstUserAadId:string,DstUserName:string,DstUserUpn:string,DstUserDomain:string,DstZone:string,DstGeoLongitude:string,DvcAction:string,DvcInboundInterface:string,DvcOutboundInterface:string,NetworkDuration:string,NetworkIcmpCode:string,NetworkIcmpType:string,DstPackets:string,SrcPackets:string,NetworkPackets:string,HttpRequestTime:string,HttpResponseTime:string,NetworkRuleName:string,NetworkRuleNumber:string,NetworkSessionId:string,SrcGeoCity:string,SrcGeoCountry:string,SrcDvcHostname:string,SrcDvcFqdn:string,SrcDvcDomain:string,SrcDvcOs:string,SrcDvcModelName:string,SrcDvcModelNumber:string,SrcDvcType:string,SrcInterfaceName:string,SrcInterfaceGuid:string,SrcIpAddr:string,SrcDvcIpAddr:string,SrcGeoLatitude:string,SrcGeoLongitude:string,SrcMacAddr:string,SrcDvcMacAddr:string,SrcPortNumber:string,SrcGeoRegion:string,SrcResourceId:string,SrcNatIpAddr:string,SrcNatPortNumber:string,SrcUserSid:string,SrcUserAadId:string,SrcUserName:string,SrcUserUpn:string,SrcUserDomain:string,SrcZone:string,NetworkProtocol:string,CloudAppName:string,CloudAppId:string,CloudAppOperation:string,CloudAppRiskLevel:string,FileName:string,FilePath:string,FileHashMd5:string,FileHashSha1:string,FileHashSha256:string,FileHashSha512:string,FileExtension:string,FileMimeType:string,FileSize:string,HttpVersion:string,HttpRequestMethod:string,HttpStatusCode:string,HttpContentType:string,HttpReferrerOriginal:string,HttpUserAgentOriginal:string,HttpRequestXff:string,UrlCategory:string,UrlOriginal:string,UrlHostname:string,ThreatCategory:string,ThreatId:string,ThreatName:string,AdditionalFields:string,SourceSystem:string,Type:string)

.create-or-alter function NetworkSessionsExpand() {
    NetworkSessionsRaw
| mv-expand events = Records | where events.Type == 'NetworkSessions' and isnotempty(events.TimeGenerated)
| project TenantId = tostring(events.TenantId),EventType = tostring(events.EventType),EventSubType = tostring(events.EventSubType),EventCount = tostring(events.EventCount),EventEndTime = todatetime(events.EventEndTime),EventMessage = tostring(events.EventMessage),DvcIpAddr = tostring(events.DvcIpAddr),DvcMacAddr = tostring(events.DvcMacAddr),DvcHostname = tostring(events.DvcHostname),EventProduct = tostring(events.EventProduct),EventProductVersion = tostring(events.EventProductVersion),EventResourceId = tostring(events.EventResourceId),EventReportUrl = tostring(events.EventReportUrl),EventVendor = tostring(events.EventVendor),EventResult = tostring(events.EventResult),EventResultDetails = tostring(events.EventResultDetails),EventSchemaVersion = tostring(events.EventSchemaVersion),EventSeverity = tostring(events.EventSeverity),EventOriginalUid = tostring(events.EventOriginalUid),EventStartTime = todatetime(events.EventStartTime),TimeGenerated = todatetime(events.TimeGenerated),EventTimeIngested = todatetime(events.EventTimeIngested),EventUid = tostring(events.EventUid),NetworkApplicationProtocol = tostring(events.NetworkApplicationProtocol),DstBytes = tostring(events.DstBytes),SrcBytes = tostring(events.SrcBytes),NetworkBytes = tostring(events.NetworkBytes),NetworkDirection = tostring(events.NetworkDirection),DstGeoCity = tostring(events.DstGeoCity),DstGeoCountry = tostring(events.DstGeoCountry),DstDvcHostname = tostring(events.DstDvcHostname),DstDvcFqdn = tostring(events.DstDvcFqdn),DstDomainHostname = tostring(events.DstDomainHostname),DstInterfaceName = tostring(events.DstInterfaceName),DstInterfaceGuid = tostring(events.DstInterfaceGuid),DstIpAddr = tostring(events.DstIpAddr),DstDvcIpAddr = tostring(events.DstDvcIpAddr),DstGeoLatitude = tostring(events.DstGeoLatitude),DstMacAddr = tostring(events.DstMacAddr),DstDvcMacAddr = tostring(events.DstDvcMacAddr),DstDvcDomain = tostring(events.DstDvcDomain),DstPortNumber = tostring(events.DstPortNumber),DstGeoRegion = tostring(events.DstGeoRegion),DstResourceId = tostring(events.DstResourceId),DstNatIpAddr = tostring(events.DstNatIpAddr),DstNatPortNumber = tostring(events.DstNatPortNumber),DstUserSid = tostring(events.DstUserSid),DstUserAadId = tostring(events.DstUserAadId),DstUserName = tostring(events.DstUserName),DstUserUpn = tostring(events.DstUserUpn),DstUserDomain = tostring(events.DstUserDomain),DstZone = tostring(events.DstZone),DstGeoLongitude = tostring(events.DstGeoLongitude),DvcAction = tostring(events.DvcAction),DvcInboundInterface = tostring(events.DvcInboundInterface),DvcOutboundInterface = tostring(events.DvcOutboundInterface),NetworkDuration = tostring(events.NetworkDuration),NetworkIcmpCode = tostring(events.NetworkIcmpCode),NetworkIcmpType = tostring(events.NetworkIcmpType),DstPackets = tostring(events.DstPackets),SrcPackets = tostring(events.SrcPackets),NetworkPackets = tostring(events.NetworkPackets),HttpRequestTime = tostring(events.HttpRequestTime),HttpResponseTime = tostring(events.HttpResponseTime),NetworkRuleName = tostring(events.NetworkRuleName),NetworkRuleNumber = tostring(events.NetworkRuleNumber),NetworkSessionId = tostring(events.NetworkSessionId),SrcGeoCity = tostring(events.SrcGeoCity),SrcGeoCountry = tostring(events.SrcGeoCountry),SrcDvcHostname = tostring(events.SrcDvcHostname),SrcDvcFqdn = tostring(events.SrcDvcFqdn),SrcDvcDomain = tostring(events.SrcDvcDomain),SrcDvcOs = tostring(events.SrcDvcOs),SrcDvcModelName = tostring(events.SrcDvcModelName),SrcDvcModelNumber = tostring(events.SrcDvcModelNumber),SrcDvcType = tostring(events.SrcDvcType),SrcInterfaceName = tostring(events.SrcInterfaceName),SrcInterfaceGuid = tostring(events.SrcInterfaceGuid),SrcIpAddr = tostring(events.SrcIpAddr),SrcDvcIpAddr = tostring(events.SrcDvcIpAddr),SrcGeoLatitude = tostring(events.SrcGeoLatitude),SrcGeoLongitude = tostring(events.SrcGeoLongitude),SrcMacAddr = tostring(events.SrcMacAddr),SrcDvcMacAddr = tostring(events.SrcDvcMacAddr),SrcPortNumber = tostring(events.SrcPortNumber),SrcGeoRegion = tostring(events.SrcGeoRegion),SrcResourceId = tostring(events.SrcResourceId),SrcNatIpAddr = tostring(events.SrcNatIpAddr),SrcNatPortNumber = tostring(events.SrcNatPortNumber),SrcUserSid = tostring(events.SrcUserSid),SrcUserAadId = tostring(events.SrcUserAadId),SrcUserName = tostring(events.SrcUserName),SrcUserUpn = tostring(events.SrcUserUpn),SrcUserDomain = tostring(events.SrcUserDomain),SrcZone = tostring(events.SrcZone),NetworkProtocol = tostring(events.NetworkProtocol),CloudAppName = tostring(events.CloudAppName),CloudAppId = tostring(events.CloudAppId),CloudAppOperation = tostring(events.CloudAppOperation),CloudAppRiskLevel = tostring(events.CloudAppRiskLevel),FileName = tostring(events.FileName),FilePath = tostring(events.FilePath),FileHashMd5 = tostring(events.FileHashMd5),FileHashSha1 = tostring(events.FileHashSha1),FileHashSha256 = tostring(events.FileHashSha256),FileHashSha512 = tostring(events.FileHashSha512),FileExtension = tostring(events.FileExtension),FileMimeType = tostring(events.FileMimeType),FileSize = tostring(events.FileSize),HttpVersion = tostring(events.HttpVersion),HttpRequestMethod = tostring(events.HttpRequestMethod),HttpStatusCode = tostring(events.HttpStatusCode),HttpContentType = tostring(events.HttpContentType),HttpReferrerOriginal = tostring(events.HttpReferrerOriginal),HttpUserAgentOriginal = tostring(events.HttpUserAgentOriginal),HttpRequestXff = tostring(events.HttpRequestXff),UrlCategory = tostring(events.UrlCategory),UrlOriginal = tostring(events.UrlOriginal),UrlHostname = tostring(events.UrlHostname),ThreatCategory = tostring(events.ThreatCategory),ThreatId = tostring(events.ThreatId),ThreatName = tostring(events.ThreatName),AdditionalFields = tostring(events.AdditionalFields),SourceSystem = tostring(events.SourceSystem),Type = tostring(events.Type)
}

.alter table NetworkSessions policy update @'[{"Source": "NetworkSessionsRaw", "Query": "NetworkSessionsExpand()", "IsEnabled": true, "IsTransactional": true}]'
