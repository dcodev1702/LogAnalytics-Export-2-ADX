.create table AnomaliesRaw (Records:dynamic)

.create table AnomaliesRaw ingestion json mapping 'AnomaliesRawMapping' '[{"column":"Records","Properties":{"path":"$.records"}}]'

.alter-merge table AnomaliesRaw policy retention softdelete = 0d

.create table Anomalies (TenantId:string,Id:string,WorkspaceId:string,VendorName:string,TimeGenerated:datetime,AnomalyTemplateId:string,AnomalyTemplateName:string,AnomalyTemplateVersion:string,RuleId:string,RuleStatus:string,RuleName:string,RuleConfigVersion:string,Score:string,Description:string,StartTime:datetime,EndTime:datetime,ExtendedLinks:string,Tactics:string,Techniques:string,UserName:string,UserPrincipalName:string,SourceIpAddress:string,SourceLocation:string,SourceDevice:string,DestinationIpAddress:string,DestinationLocation:string,DestinationDevice:string,ActivityInsights:string,DeviceInsights:string,UserInsights:string,AnomalyReasons:string,Entities:string,ExtendedProperties:string,AnomalyDetails:string,SourceSystem:string,Type:string)

.create-or-alter function AnomaliesExpand() { AnomaliesRaw| mv-expand events = Records| where events.Type == 'Anomalies'| project TenantId = tostring(events.TenantId),Id = tostring(events.Id),WorkspaceId = tostring(events.WorkspaceId),VendorName = tostring(events.VendorName),TimeGenerated = todatetime(events.TimeGenerated),AnomalyTemplateId = tostring(events.AnomalyTemplateId),AnomalyTemplateName = tostring(events.AnomalyTemplateName),AnomalyTemplateVersion = tostring(events.AnomalyTemplateVersion),RuleId = tostring(events.RuleId),RuleStatus = tostring(events.RuleStatus),RuleName = tostring(events.RuleName),RuleConfigVersion = tostring(events.RuleConfigVersion),Score = tostring(events.Score),Description = tostring(events.Description),StartTime = todatetime(events.StartTime),EndTime = todatetime(events.EndTime),ExtendedLinks = tostring(events.ExtendedLinks),Tactics = tostring(events.Tactics),Techniques = tostring(events.Techniques),UserName = tostring(events.UserName),UserPrincipalName = tostring(events.UserPrincipalName),SourceIpAddress = tostring(events.SourceIpAddress),SourceLocation = tostring(events.SourceLocation),SourceDevice = tostring(events.SourceDevice),DestinationIpAddress = tostring(events.DestinationIpAddress),DestinationLocation = tostring(events.DestinationLocation),DestinationDevice = tostring(events.DestinationDevice),ActivityInsights = tostring(events.ActivityInsights),DeviceInsights = tostring(events.DeviceInsights),UserInsights = tostring(events.UserInsights),AnomalyReasons = tostring(events.AnomalyReasons),Entities = tostring(events.Entities),ExtendedProperties = tostring(events.ExtendedProperties),AnomalyDetails = tostring(events.AnomalyDetails),SourceSystem = tostring(events.SourceSystem),Type = tostring(events.Type)}

.alter table Anomalies policy update @'[{"Source": "AnomaliesRaw", "Query": "AnomaliesExpand()", "IsEnabled": true, "IsTransactional": true}]'
