.create table CommonSecurityLogRaw (Records:dynamic)

.create table CommonSecurityLogRaw ingestion json mapping 'CommonSecurityLogRawMapping' '[{"column":"Records","Properties":{"path":"$.records"}}]'

.alter-merge table CommonSecurityLogRaw policy retention softdelete = 0d

.create table CommonSecurityLog (TenantId:string,TimeGenerated:datetime,DeviceVendor:string,DeviceProduct:string,DeviceVersion:string,DeviceEventClassID:string,Activity:string,LogSeverity:string,OriginalLogSeverity:string,AdditionalExtensions:string,DeviceAction:string,ApplicationProtocol:string,EventCount:string,DestinationDnsDomain:string,DestinationServiceName:string,DestinationTranslatedAddress:string,DestinationTranslatedPort:string,CommunicationDirection:string,DeviceDnsDomain:string,DeviceExternalID:string,DeviceFacility:string,DeviceInboundInterface:string,DeviceNtDomain:string,DeviceOutboundInterface:string,DevicePayloadId:string,ProcessName:string,DeviceTranslatedAddress:string,DestinationHostName:string,DestinationMACAddress:string,DestinationNTDomain:string,DestinationProcessId:string,DestinationUserPrivileges:string,DestinationProcessName:string,DestinationPort:string,DestinationIP:string,DeviceTimeZone:string,DestinationUserID:string,DestinationUserName:string,DeviceAddress:string,DeviceName:string,DeviceMacAddress:string,ProcessID:string,EndTime:datetime,ExternalID:string,ExtID:string,FileCreateTime:string,FileHash:string,FileID:string,FileModificationTime:string,FilePath:string,FilePermission:string,FileType:string,FileName:string,FileSize:string,ReceivedBytes:string,Message:string,OldFileCreateTime:string,OldFileHash:string,OldFileID:string,OldFileModificationTime:string,OldFileName:string,OldFilePath:string,OldFilePermission:string,OldFileSize:string,OldFileType:string,SentBytes:string,EventOutcome:string,Protocol:string,Reason:string,RequestURL:string,RequestClientApplication:string,RequestContext:string,RequestCookies:string,RequestMethod:string,ReceiptTime:string,SourceHostName:string,SourceMACAddress:string,SourceNTDomain:string,SourceDnsDomain:string,SourceServiceName:string,SourceTranslatedAddress:string,SourceTranslatedPort:string,SourceProcessId:string,SourceUserPrivileges:string,SourceProcessName:string,SourcePort:string,SourceIP:string,StartTime:datetime,SourceUserID:string,SourceUserName:string,EventType:string,DeviceEventCategory:string,DeviceCustomIPv6Address1:string,DeviceCustomIPv6Address1Label:string,DeviceCustomIPv6Address2:string,DeviceCustomIPv6Address2Label:string,DeviceCustomIPv6Address3:string,DeviceCustomIPv6Address3Label:string,DeviceCustomIPv6Address4:string,DeviceCustomIPv6Address4Label:string,DeviceCustomFloatingPoint1:string,DeviceCustomFloatingPoint1Label:string,DeviceCustomFloatingPoint2:string,DeviceCustomFloatingPoint2Label:string,DeviceCustomFloatingPoint3:string,DeviceCustomFloatingPoint3Label:string,DeviceCustomFloatingPoint4:string,DeviceCustomFloatingPoint4Label:string,DeviceCustomNumber1:string,FieldDeviceCustomNumber1:string,DeviceCustomNumber1Label:string,DeviceCustomNumber2:string,FieldDeviceCustomNumber2:string,DeviceCustomNumber2Label:string,DeviceCustomNumber3:string,FieldDeviceCustomNumber3:string,DeviceCustomNumber3Label:string,DeviceCustomString1:string,DeviceCustomString1Label:string,DeviceCustomString2:string,DeviceCustomString2Label:string,DeviceCustomString3:string,DeviceCustomString3Label:string,DeviceCustomString4:string,DeviceCustomString4Label:string,DeviceCustomString5:string,DeviceCustomString5Label:string,DeviceCustomString6:string,DeviceCustomString6Label:string,DeviceCustomDate1:string,DeviceCustomDate1Label:string,DeviceCustomDate2:string,DeviceCustomDate2Label:string,FlexDate1:string,FlexDate1Label:string,FlexNumber1:string,FlexNumber1Label:string,FlexNumber2:string,FlexNumber2Label:string,FlexString1:string,FlexString1Label:string,FlexString2:string,FlexString2Label:string,RemoteIP:string,RemotePort:string,MaliciousIP:string,ThreatSeverity:string,IndicatorThreatType:string,ThreatDescription:string,ThreatConfidence:string,ReportReferenceLink:string,MaliciousIPLongitude:string,MaliciousIPLatitude:string,MaliciousIPCountry:string,Computer:string,SourceSystem:string,SimplifiedDeviceAction:string,Type:string,_ResourceId:string)

.create-or-alter function CommonSecurityLogExpand() { CommonSecurityLogRaw| mv-expand events = Records| where events.Type == 'CommonSecurityLog' and isnotempty(events.TimeGenerated) | project TenantId = tostring(events.TenantId),TimeGenerated = todatetime(events.TimeGenerated),DeviceVendor = tostring(events.DeviceVendor),DeviceProduct = tostring(events.DeviceProduct),DeviceVersion = tostring(events.DeviceVersion),DeviceEventClassID = tostring(events.DeviceEventClassID),Activity = tostring(events.Activity),LogSeverity = tostring(events.LogSeverity),OriginalLogSeverity = tostring(events.OriginalLogSeverity),AdditionalExtensions = tostring(events.AdditionalExtensions),DeviceAction = tostring(events.DeviceAction),ApplicationProtocol = tostring(events.ApplicationProtocol),EventCount = tostring(events.EventCount),DestinationDnsDomain = tostring(events.DestinationDnsDomain),DestinationServiceName = tostring(events.DestinationServiceName),DestinationTranslatedAddress = tostring(events.DestinationTranslatedAddress),DestinationTranslatedPort = tostring(events.DestinationTranslatedPort),CommunicationDirection = tostring(events.CommunicationDirection),DeviceDnsDomain = tostring(events.DeviceDnsDomain),DeviceExternalID = tostring(events.DeviceExternalID),DeviceFacility = tostring(events.DeviceFacility),DeviceInboundInterface = tostring(events.DeviceInboundInterface),DeviceNtDomain = tostring(events.DeviceNtDomain),DeviceOutboundInterface = tostring(events.DeviceOutboundInterface),DevicePayloadId = tostring(events.DevicePayloadId),ProcessName = tostring(events.ProcessName),DeviceTranslatedAddress = tostring(events.DeviceTranslatedAddress),DestinationHostName = tostring(events.DestinationHostName),DestinationMACAddress = tostring(events.DestinationMACAddress),DestinationNTDomain = tostring(events.DestinationNTDomain),DestinationProcessId = tostring(events.DestinationProcessId),DestinationUserPrivileges = tostring(events.DestinationUserPrivileges),DestinationProcessName = tostring(events.DestinationProcessName),DestinationPort = tostring(events.DestinationPort),DestinationIP = tostring(events.DestinationIP),DeviceTimeZone = tostring(events.DeviceTimeZone),DestinationUserID = tostring(events.DestinationUserID),DestinationUserName = tostring(events.DestinationUserName),DeviceAddress = tostring(events.DeviceAddress),DeviceName = tostring(events.DeviceName),DeviceMacAddress = tostring(events.DeviceMacAddress),ProcessID = tostring(events.ProcessID),EndTime = todatetime(events.EndTime),ExternalID = tostring(events.ExternalID),ExtID = tostring(events.ExtID),FileCreateTime = tostring(events.FileCreateTime),FileHash = tostring(events.FileHash),FileID = tostring(events.FileID),FileModificationTime = tostring(events.FileModificationTime),FilePath = tostring(events.FilePath),FilePermission = tostring(events.FilePermission),FileType = tostring(events.FileType),FileName = tostring(events.FileName),FileSize = tostring(events.FileSize),ReceivedBytes = tostring(events.ReceivedBytes),Message = tostring(events.Message),OldFileCreateTime = tostring(events.OldFileCreateTime),OldFileHash = tostring(events.OldFileHash),OldFileID = tostring(events.OldFileID),OldFileModificationTime = tostring(events.OldFileModificationTime),OldFileName = tostring(events.OldFileName),OldFilePath = tostring(events.OldFilePath),OldFilePermission = tostring(events.OldFilePermission),OldFileSize = tostring(events.OldFileSize),OldFileType = tostring(events.OldFileType),SentBytes = tostring(events.SentBytes),EventOutcome = tostring(events.EventOutcome),Protocol = tostring(events.Protocol),Reason = tostring(events.Reason),RequestURL = tostring(events.RequestURL),RequestClientApplication = tostring(events.RequestClientApplication),RequestContext = tostring(events.RequestContext),RequestCookies = tostring(events.RequestCookies),RequestMethod = tostring(events.RequestMethod),ReceiptTime = tostring(events.ReceiptTime),SourceHostName = tostring(events.SourceHostName),SourceMACAddress = tostring(events.SourceMACAddress),SourceNTDomain = tostring(events.SourceNTDomain),SourceDnsDomain = tostring(events.SourceDnsDomain),SourceServiceName = tostring(events.SourceServiceName),SourceTranslatedAddress = tostring(events.SourceTranslatedAddress),SourceTranslatedPort = tostring(events.SourceTranslatedPort),SourceProcessId = tostring(events.SourceProcessId),SourceUserPrivileges = tostring(events.SourceUserPrivileges),SourceProcessName = tostring(events.SourceProcessName),SourcePort = tostring(events.SourcePort),SourceIP = tostring(events.SourceIP),StartTime = todatetime(events.StartTime),SourceUserID = tostring(events.SourceUserID),SourceUserName = tostring(events.SourceUserName),EventType = tostring(events.EventType),DeviceEventCategory = tostring(events.DeviceEventCategory),DeviceCustomIPv6Address1 = tostring(events.DeviceCustomIPv6Address1),DeviceCustomIPv6Address1Label = tostring(events.DeviceCustomIPv6Address1Label),DeviceCustomIPv6Address2 = tostring(events.DeviceCustomIPv6Address2),DeviceCustomIPv6Address2Label = tostring(events.DeviceCustomIPv6Address2Label),DeviceCustomIPv6Address3 = tostring(events.DeviceCustomIPv6Address3),DeviceCustomIPv6Address3Label = tostring(events.DeviceCustomIPv6Address3Label),DeviceCustomIPv6Address4 = tostring(events.DeviceCustomIPv6Address4),DeviceCustomIPv6Address4Label = tostring(events.DeviceCustomIPv6Address4Label),DeviceCustomFloatingPoint1 = tostring(events.DeviceCustomFloatingPoint1),DeviceCustomFloatingPoint1Label = tostring(events.DeviceCustomFloatingPoint1Label),DeviceCustomFloatingPoint2 = tostring(events.DeviceCustomFloatingPoint2),DeviceCustomFloatingPoint2Label = tostring(events.DeviceCustomFloatingPoint2Label),DeviceCustomFloatingPoint3 = tostring(events.DeviceCustomFloatingPoint3),DeviceCustomFloatingPoint3Label = tostring(events.DeviceCustomFloatingPoint3Label),DeviceCustomFloatingPoint4 = tostring(events.DeviceCustomFloatingPoint4),DeviceCustomFloatingPoint4Label = tostring(events.DeviceCustomFloatingPoint4Label),DeviceCustomNumber1 = tostring(events.DeviceCustomNumber1),FieldDeviceCustomNumber1 = tostring(events.FieldDeviceCustomNumber1),DeviceCustomNumber1Label = tostring(events.DeviceCustomNumber1Label),DeviceCustomNumber2 = tostring(events.DeviceCustomNumber2),FieldDeviceCustomNumber2 = tostring(events.FieldDeviceCustomNumber2),DeviceCustomNumber2Label = tostring(events.DeviceCustomNumber2Label),DeviceCustomNumber3 = tostring(events.DeviceCustomNumber3),FieldDeviceCustomNumber3 = tostring(events.FieldDeviceCustomNumber3),DeviceCustomNumber3Label = tostring(events.DeviceCustomNumber3Label),DeviceCustomString1 = tostring(events.DeviceCustomString1),DeviceCustomString1Label = tostring(events.DeviceCustomString1Label),DeviceCustomString2 = tostring(events.DeviceCustomString2),DeviceCustomString2Label = tostring(events.DeviceCustomString2Label),DeviceCustomString3 = tostring(events.DeviceCustomString3),DeviceCustomString3Label = tostring(events.DeviceCustomString3Label),DeviceCustomString4 = tostring(events.DeviceCustomString4),DeviceCustomString4Label = tostring(events.DeviceCustomString4Label),DeviceCustomString5 = tostring(events.DeviceCustomString5),DeviceCustomString5Label = tostring(events.DeviceCustomString5Label),DeviceCustomString6 = tostring(events.DeviceCustomString6),DeviceCustomString6Label = tostring(events.DeviceCustomString6Label),DeviceCustomDate1 = tostring(events.DeviceCustomDate1),DeviceCustomDate1Label = tostring(events.DeviceCustomDate1Label),DeviceCustomDate2 = tostring(events.DeviceCustomDate2),DeviceCustomDate2Label = tostring(events.DeviceCustomDate2Label),FlexDate1 = tostring(events.FlexDate1),FlexDate1Label = tostring(events.FlexDate1Label),FlexNumber1 = tostring(events.FlexNumber1),FlexNumber1Label = tostring(events.FlexNumber1Label),FlexNumber2 = tostring(events.FlexNumber2),FlexNumber2Label = tostring(events.FlexNumber2Label),FlexString1 = tostring(events.FlexString1),FlexString1Label = tostring(events.FlexString1Label),FlexString2 = tostring(events.FlexString2),FlexString2Label = tostring(events.FlexString2Label),RemoteIP = tostring(events.RemoteIP),RemotePort = tostring(events.RemotePort),MaliciousIP = tostring(events.MaliciousIP),ThreatSeverity = tostring(events.ThreatSeverity),IndicatorThreatType = tostring(events.IndicatorThreatType),ThreatDescription = tostring(events.ThreatDescription),ThreatConfidence = tostring(events.ThreatConfidence),ReportReferenceLink = tostring(events.ReportReferenceLink),MaliciousIPLongitude = tostring(events.MaliciousIPLongitude),MaliciousIPLatitude = tostring(events.MaliciousIPLatitude),MaliciousIPCountry = tostring(events.MaliciousIPCountry),Computer = tostring(events.Computer),SourceSystem = tostring(events.SourceSystem),SimplifiedDeviceAction = tostring(events.SimplifiedDeviceAction),Type = tostring(events.Type),_ResourceId = tostring(events._ResourceId)}

.alter table CommonSecurityLog policy update @'[{"Source": "CommonSecurityLogRaw", "Query": "CommonSecurityLogExpand()", "IsEnabled": true, "IsTransactional": true}]'
